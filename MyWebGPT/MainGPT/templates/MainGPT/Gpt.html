{% extends 'MainGPT/layout.html' %}
{% load static %}

{% block BodyContent %}
<img id="burgerBtn" src="{% static 'MainGPT/img/BurgerPanel2.png'%}" alt="">

<div id="SideBar">

    <div class="BlocksBtnOnSideBar" id="BlockAccount" style="margin-top: 5%;">
        <div class="BlockForBtnOnSidebar">
            <a id="ButtonToAccount" href="/account/profile" class="Text_BlockForBtnOnSidebar">Аккаунт</a>
        </div>
        
    </div>

    <div class="BlocksBtnOnSideBar" id="BlockNewChat">
        <div class="BlockForBtnOnSidebar" id="BtnCreateNewChat">
            <h1 id="textNewChat" class="Text_BlockForBtnOnSidebar">Новый чат</h1>
        </div>

            <div class="BlockForBtnOnSidebar ChildBlockCreateNewChat">
                <h1 id="textNewChat" class="Text_BlockForBtnOnSidebar ChildTextCreateNewChat">Генерация изображений</h1>
            </div>

            <div class="BlockForBtnOnSidebar ChildBlockCreateNewChat">
                <h1 id="textNewChat" class="Text_BlockForBtnOnSidebar ChildTextCreateNewChat">Решение примеров по фото</h1>
            </div>

    </div>

    <div class="BlocksBtnOnSideBar" id="BlockRemoveChat">
        <div class="BlockForBtnOnSidebar">
            <h1 class="Text_BlockForBtnOnSidebar">Отчистить чат</h1>
        </div>
    </div>

    <div class="BlocksBtnOnSideBar" id="BlockSettings">
        <div class="BlockForBtnOnSidebar">
            <h1 class="Text_BlockForBtnOnSidebar">Настройки</h1>
        </div>
    </div>

    <div id="InfoPanel">
        <div class="BtnOnInfoPanel">
            <div id="PanelChatOnInfoPanel">
                <img class="ImageOnInfoPanel" src="{%static 'MainGPT/img/chat.png'%}" alt="">
                <h4 class="NameBTNOnInfoPanel">Chat AI</h4>
            </div>
        </div>

        <div class="BtnOnInfoPanel">
            <div id="PanelChatOnInfoPanel">
                <img class="ImageOnInfoPanel" src="{%static 'MainGPT/img/info.png'%}" alt="">
                <h4 class="NameBTNOnInfoPanel">О нас</h4>
            </div>
        </div>

        <div class="BtnOnInfoPanel">
            <div id="PanelChatOnInfoPanel">
                <img class="ImageOnInfoPanel" src="{%static 'MainGPT/img/Contact.png'%}" alt="">
                <h4 class="NameBTNOnInfoPanel">Контакты</h4>
            </div>
        </div>


    </div>
</div>

<div id="GlobalChat">
    
        <div id="Chat">
            <div id="hints">
                <div id="BlockForTextInHeaderHints"><h1 id="TextInHeaderHints">Чем могу помочь?</h1></div>

                
            </div>
            <div id="BottomPanel"> 
                <textarea id="inputChat" placeholder="Введите сообщение..."></textarea>
                <p>Любая нейросеть не гарантирует 100 процентную вероятность точности ответов. <b>Перепроверяйте важную информацию!</b></p>
            </div>
        </div>
</div>





<link rel="stylesheet" href="{% static 'MainGPT/css/Gpt.css' %}">

<!-- Сторонние файлы и бибилотеки -->

    <script src="{%static 'MainGPT/js/Main.js'%}"></script>
    <script src="https://unpkg.com/fitty"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Сторонние файлы и бибилотеки -->

<script>
window.addEventListener('DOMContentLoaded', () => {
    


function checkForUserMessages() 
{
    console.log('функция checkForUserMessages - Начало');
    const chatElement = document.querySelector('#Chat');
    const hintsElement = document.querySelector('#hints');
    
    if (chatElement != null)
    {
        console.log('chatElement != null');
        if(hintsElement != null)
        {
            console.log('hintsElement != null');
            const userMessages = chatElement.querySelectorAll('.UserMessage'); 

            if (userMessages.length > 0) 
            {
                hintsElement.style.display = 'none'; // Скрываем #hints
                console.log("Скрываем подсказки");
            } 

            else {
                
                hintsElement.style.display = ''; // Показываем (если скрыто)
                console.log("Показываем подсказки");
                
            }
        }
    } 
    else{
        console.log('chatElement == null');
    }
    
}
checkForUserMessages();

const input = document.getElementById("inputChat");
function SetBottomPaddingForGptMessage() {
    const chatContainer = document.getElementById('Chat');
    const gptMessages = chatContainer.querySelectorAll('.GPTMessage');
    const lastGptMessage = gptMessages[gptMessages.length - 1];
    // const previous_lastGptMessage = gptMessages[gptMessages.length - 2];

    const UserMessages = chatContainer.querySelectorAll('.UserMessage');
    const lastUserMessage = UserMessages[UserMessages.length - 1];

    if (lastGptMessage) {
        lastUserMessage.style.paddingBottom = '1vw';
        lastGptMessage.style.paddingBottom = '10vw';
        // previous_lastGptMessage.style.paddingBottom = '1vw';

    }
}

function SetBottomPaddingForUserMessage() {
    const chatContainer = document.getElementById('Chat');
    const UserMessages = chatContainer.querySelectorAll('.UserMessage');
    const lastUserMessage = UserMessages[UserMessages.length - 1];

    const gptMessages = chatContainer.querySelectorAll('.GPTMessage');
    const lastGptMessage = gptMessages[gptMessages.length - 1];

    if (UserMessages) {
        if (lastGptMessage)
            {
                lastGptMessage.style.paddingBottom = '1vw';
            }
        lastUserMessage.style.paddingBottom = '10vw';
    }
}


const userInput = document.getElementById('inputChat'); // Теперь userInput содержит сам input



function CreateNewMessageByUser(message, save = true) {
    const NewUserMessage = document.createElement('div');
    NewUserMessage.classList.add("UserMessage");

    const UserIcon = document.createElement('img');
    UserIcon.src = "{% static 'MainGPT/img/free-icon-user.png' %}";
    UserIcon.alt = "User Icon";
    UserIcon.classList.add("User-Icon");

    const UserText = document.createElement('h1');
    UserText.classList.add("TextUserPrompt");
    UserText.innerHTML = message;

    NewUserMessage.appendChild(UserIcon);
    NewUserMessage.appendChild(UserText);
    document.getElementById("Chat").appendChild(NewUserMessage);

    SetBottomPaddingForUserMessage();
    checkForUserMessages();

    if (save) {
        chatHistory.push({ role: "user", content: message });
        localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }
}

function CreateNewMessageByGPT(data, save = true) {
    const sanitizedAnswer = data.replace(/<br>/g, '\n'); 
    const htmlContent = marked.parse(sanitizedAnswer);

    const NewGPTMessage = document.createElement('div');
    NewGPTMessage.classList.add("GPTMessage");

    const GPTText = document.createElement('h1');
    GPTText.classList.add("TextGtpAnswer");
    GPTText.innerHTML = htmlContent;

    const GPTIcon = document.createElement('img');
    GPTIcon.src = "{% static 'MainGPT/img/icon-GPT.png' %}";
    GPTIcon.alt = "GPT Icon";
    GPTIcon.classList.add("GPT-Icon");

    NewGPTMessage.appendChild(GPTIcon);
    NewGPTMessage.appendChild(GPTText);
    document.getElementById("Chat").appendChild(NewGPTMessage);

    SetBottomPaddingForGptMessage();
    userInput.disabled = false;

    if (save) {
        chatHistory.push({ role: "gpt", content: data });
        localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }
}

async function PostPromptChatGPT(Prompt) {
    try {
        const response = await fetch(`https://gpt-api-production-ba31.up.railway.app/DeepSeek`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            mode: 'cors',
            body: JSON.stringify({
                prompt: Prompt
            })
        });

        if (!response.ok) {
            throw new Error('Сеть ответила с ошибкой');
        }

        const data = await response.json();
        console.log("Ответ от GPT пришёл.");
        return data.response;

    } catch (error) {
        console.error('Возникла проблема с запросом:', error);
        return null; // или можно выбросить ошибку — зависит от логики
    }
}



function SendPromptGPT(MsgPrompt) {
    fetch(`https://gpt-api-production-ba31.up.railway.app/DeepSeek`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        mode: 'cors',
        body: JSON.stringify({
            prompt: MsgPrompt
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Сеть ответила с ошибкой');
        }
        return response.json();
    })
    .then(data => {
        console.log("Запрос отправился и вернулся корректно");
        console.log(data);
        
        CreateNewMessageByGPT(data.response);  // учитываем структуру ответа
        return data.response
    })
    .catch(error => {
        console.error('Возникла проблема с запросом:', error);
        CreateNewMessageByGPT('Ошибка при запросе к серверу. Попробуйте позже.');
    });
}

userInput.addEventListener('keydown', function(event) {
if (event.key === 'Enter') {
    if (event.shiftKey) {
        // Добавляем перенос строки
        event.preventDefault();
        const cursorPos = userInput.selectionStart;
        const value = userInput.value;
        userInput.value = value.substring(0, cursorPos) + "\n" + value.substring(cursorPos);
        userInput.selectionStart = userInput.selectionEnd = cursorPos + 1;
        AutoResizeTextarea(); // обновим высоту
    } else {
        // Отправка сообщения
        event.preventDefault();
        userInput.disabled = true;
        const MsgPrompt = userInput.value.trim();
        if (MsgPrompt !== '') {
            CreateNewMessageByUser(MsgPrompt);
            SendPromptGPT(MsgPrompt);
            userInput.value = '';
            AutoResizeTextarea();
        }
    }
}
});
function AutoResizeTextarea() {
userInput.style.height = "auto"; // сброс
const lineHeight = 20; // px, можешь точно замерить по шрифту
const maxHeight = lineHeight * 10;

if (userInput.scrollHeight > maxHeight) {
    userInput.style.height = maxHeight + "px";
    userInput.style.overflowY = "scroll";
} else {
    userInput.style.height = userInput.scrollHeight + "px";
    userInput.style.overflowY = "hidden";
}
}
userInput.addEventListener('input', AutoResizeTextarea);
let chatHistory = [];


function loadChatHistory() {
const stored = localStorage.getItem('chatHistory');
if (stored) {
    chatHistory = JSON.parse(stored);
    chatHistory.forEach(msg => {
        if (msg.role === "user") {
            CreateNewMessageByUser(msg.content, false);
        } else if (msg.role === "gpt") {
            CreateNewMessageByGPT(msg.content, false);
        }
    });
    AutoResizeTextarea();
}
}
loadChatHistory();

});


const BlocksBtnOnSideBar = document.getElementsByClassName("BlocksBtnOnSideBar");

for (let block of BlocksBtnOnSideBar) {
    block.addEventListener("mouseover", () => {
        block.classList.remove("BlocksBtnOnSideBar_NotHover");
        block.classList.add("BlocksBtnOnSideBar_Hover");
    });

    block.addEventListener("mouseout", () => {
        block.classList.remove("BlocksBtnOnSideBar_Hover");
        block.classList.add("BlocksBtnOnSideBar_NotHover");
    });
}

function removeHistory(){
    localStorage.clear();
    location.reload();
}
const BlockRemoveChat = document.getElementById("BlockRemoveChat").addEventListener("click", removeHistory);




const BlockNewChat = document.getElementById("BlockNewChat");
// BlockRemoveChat BlockSettings
BlockNewChat.addEventListener("click", (event) => {

    var IsActive = false;
    if (event.target === BlockNewChat) return;
    
    const childBlocks = document.querySelectorAll(".ChildBlockCreateNewChat");
    console.log("TEST");
    
    for (let block of childBlocks) {
        if (block.style.display === 'none') {
            block.style.display = 'block'; 
            IsActive = true;
        } else {
            block.style.display = 'none'; 
        }
    }

    if(IsActive == true)
    {
        document.getElementById("BlockRemoveChat").style.transform = "translateY(150px)";
        document.getElementById("BlockSettings").style.transform = "translateY(150px)";
    }
});

</script>
{% endblock %}
