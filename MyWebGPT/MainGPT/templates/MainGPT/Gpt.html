{% extends 'MainGPT/layout.html' %}
{% load static %}

{% block BodyContent %}


<div id="GlobalChat">
    
        <div id="Chat">
            <div id="hints">
                <img id="LogoOnHints" src="{%static 'MainGPT/img/LogoST.png'%}" alt="">
                <div id="BlockForWelcometext">
                    <h1 id="WelcomeText">–ü—Ä–∏–≤–µ—Ç! –Ø - –ù–µ–π—Ä–æ –°–∞–ª–∞—Ç</h1>
                    <h4>–ù–µ–π—Ä–æ —Å–∞–ª–∞—Ç - —ç—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ä–∞–∑–Ω—ã–º –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º –∏ —É–¥–æ–±–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º üßê</h4>
                    <div id="BlockForBlocksOnWelcomePanel">
                        <div class="InfoForBotBlocks">
                            <div class="BlockForBlockImageOnWelcomePanel">
                                <div class="BlockForImageOnWelcomePanel">
                                    <img class="Welcome_ImageOnInfo" src="{%static 'MainGPT/img/chat.png'%}" alt="">   
                                </div>
                            </div>

                            <h1 class="Welcome_HeaderOnInfo">Chat AI</h1>
                            <h3 class="Welcome_DescriptionPanels">–ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã —Ä–∞–∑–Ω—ã–º –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º –∏ –ø–æ–ª—É—á–∞–π –æ—Ç–≤–µ—Ç—ã –∏\–∏–ª–∏ —Å–æ–≤–µ—Ç—ã.</h3>
                        </div>

                        <div class="InfoForBotBlocks">
                            <div class="BlockForBlockImageOnWelcomePanel">
                                <div class="BlockForImageOnWelcomePanel">
                                    <img class="Welcome_ImageOnInfo" src="{%static 'MainGPT/img/PhotoLogo (2).png'%}" alt="">   
                                </div>
                            </div>

                            <h1 class="Welcome_HeaderOnInfo">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–æ—Ç–æ</h1>
                            <h3 class="Welcome_DescriptionPanels">–ì–µ–Ω–µ—Ä–∏—Ä—É–π –ª—é–±—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è! –í—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ª–∏—à—å —É —Ç–µ–±—è –≤ –≥–æ–ª–æ–≤–µ</h3>
                        </div>
                        <div class="InfoForBotBlocks">
                            <div class="BlockForBlockImageOnWelcomePanel">
                                <div class="BlockForImageOnWelcomePanel">
                                    <img class="Welcome_ImageOnInfo" src="{%static 'MainGPT/img/LogoChat.png'%}" alt="">   
                                </div>
                            </div>

                            <h1 class="Welcome_HeaderOnInfo">–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –ø–æ —Ñ–æ—Ç–æ</h1>
                            <h3 class="Welcome_DescriptionPanels">–ù–µ –º–æ–∂–µ—à—å —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–¥–∞—á–µ–π? - –°—Ñ–æ—Ç–∫–∞–π –µ—ë –∏ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ!</h3>
                        </div>
                    </div>
                    
               
                </div>
                
            </div>
            
            <div id="BottomPanel"> 
                <div id="BlockSelectModel">
                    <h1 id="select_gpt4o" class="BtnModels">Chat GPT-4o</h1>
                    <h1 id="select_gpt4omini" class="BtnModels">Chat GPT-4o mini</h1>
                    <h1 id="select_deepseek" class="BtnModels">DeepSeek</h1>
                    <h1 id="select_llama" class="BtnModels">Llama3-3</h1>
                </div>
                <div id="BtnChangeModel">
                    <h2 id="NameModelOnBtn">–í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å</h2>
                     <img id="ImgArrowDown" src="{%static 'MainGPT/img/IconDown.png'%}" alt="">
                </div>
                <textarea id="inputChat" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... " style="user-select: none;"></textarea>
                <p>–õ—é–±–∞—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç 100 –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—É—é –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ç–æ—á–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤. <b>–ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é!</b></p>
            </div>
        </div>
</div>





<link rel="stylesheet" href="{% static 'MainGPT/css/Gpt.css' %}">

<!-- –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ñ–∞–π–ª—ã –∏ –±–∏–±–∏–ª–æ—Ç–µ–∫–∏ -->

    <script src="{%static 'MainGPT/js/Main.js'%}"></script>
    <script src="https://unpkg.com/fitty"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="{%static 'MainGPT/js/Sidebar.js'%}"> </script>

<!-- –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ñ–∞–π–ª—ã –∏ –±–∏–±–∏–ª–æ—Ç–µ–∫–∏ -->

<script>

var ValidModels = ["ChatGPT", "ChatGPTmini", "DeepSeek", "Llama3-3"];
let ActiveModel = "";
const userInput = document.getElementById('inputChat'); 



window.addEventListener('DOMContentLoaded', () => {
userInput.disabled = true;


function checkForUserMessages() 
{
    console.log('—Ñ—É–Ω–∫—Ü–∏—è checkForUserMessages - –ù–∞—á–∞–ª–æ');
    const chatElement = document.querySelector('#Chat');
    const hintsElement = document.querySelector('#hints');
    
    if (chatElement != null)
    {
        console.log('chatElement != null');
        if(hintsElement != null)
        {
            console.log('hintsElement != null');
            const userMessages = chatElement.querySelectorAll('.UserMessage'); 

            if (userMessages.length > 0) 
            {
                hintsElement.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º #hints
                document.getElementById("NameProject").classList.add("NameProjectHide");
                console.log("–°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏");
            } 

            else {
                
                document.getElementById("NameProject").style.display = 'block';
                hintsElement.style.display = ''; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º (–µ—Å–ª–∏ —Å–∫—Ä—ã—Ç–æ)
                console.log("–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏");
                
            }
        }
    } 
    else{
        console.log('chatElement == null');
    }
    
}
checkForUserMessages();

const input = document.getElementById("inputChat");
function SetBottomPaddingForGptMessage() {
    const chatContainer = document.getElementById('Chat');
    const gptMessages = chatContainer.querySelectorAll('.GPTMessage');
    const lastGptMessage = gptMessages[gptMessages.length - 1];
    // const previous_lastGptMessage = gptMessages[gptMessages.length - 2];

    const UserMessages = chatContainer.querySelectorAll('.UserMessage');
    const lastUserMessage = UserMessages[UserMessages.length - 1];

    if (lastGptMessage) {
        lastUserMessage.style.paddingBottom = '1vw';
        lastGptMessage.style.paddingBottom = '10vw';
        // previous_lastGptMessage.style.paddingBottom = '1vw';

    }
}

function SetBottomPaddingForUserMessage() {
    const chatContainer = document.getElementById('Chat');
    const UserMessages = chatContainer.querySelectorAll('.UserMessage');
    const lastUserMessage = UserMessages[UserMessages.length - 1];

    const gptMessages = chatContainer.querySelectorAll('.GPTMessage');
    const lastGptMessage = gptMessages[gptMessages.length - 1];

    if (UserMessages) {
        if (lastGptMessage)
            {
                lastGptMessage.style.paddingBottom = '1vw';
            }
        lastUserMessage.style.paddingBottom = '10vw';
    }
}






function CreateNewMessageByUser(message, save = true) {
    const NewUserMessage = document.createElement('div');
    NewUserMessage.classList.add("UserMessage");

    const UserIcon = document.createElement('img');
    UserIcon.src = "{% static 'MainGPT/img/free-icon-user.png' %}";
    UserIcon.alt = "User Icon";
    UserIcon.classList.add("User-Icon");

    const UserText = document.createElement('h1');
    UserText.classList.add("TextUserPrompt");
    UserText.innerHTML = message;

    NewUserMessage.appendChild(UserIcon);
    NewUserMessage.appendChild(UserText);
    document.getElementById("Chat").appendChild(NewUserMessage);

    SetBottomPaddingForUserMessage();
    checkForUserMessages();

    if (save) {
        chatHistory.push({ role: "user", content: message });
        localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }
}

function CreateNewMessageByGPT(data, save = true, NeedMod) {
    
    if(ValidModels.includes(ActiveModel))
    {
        let AnswerGPT = data
        const NewGPTMessage = document.createElement('div');
        NewGPTMessage.classList.add("GPTMessage");

        const GPTText = document.createElement('h1');
        GPTText.classList.add("TextGtpAnswer");
        if(ActiveModel == "DeepSeek" || ActiveModel == "ChatGPT")
        {
            try{
                AnswerGPT = marked.parse(data.text);
            }
            catch{
                console.log("–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å.")
            }
            
        }
        
        GPTText.innerHTML = AnswerGPT;

        const GPTIcon = document.createElement('img');
        GPTIcon.src = "{% static 'MainGPT/img/icon-GPT.png' %}";
        GPTIcon.alt = "GPT Icon";
        GPTIcon.classList.add("GPT-Icon");

        NewGPTMessage.appendChild(GPTIcon);
        NewGPTMessage.appendChild(GPTText);
        document.getElementById("Chat").appendChild(NewGPTMessage);

        SetBottomPaddingForGptMessage();
        userInput.disabled = false;

        if (save) {
            chatHistory.push({ role: "gpt", content: data });
            localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
        }
        

        
    }else{
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–æ–¥–µ–ª–∏.")
    }

   
    
   
}

function SendPromptNeiro(MsgPrompt, Model) {
    const exists = ValidModels.includes(Model);
    if(exists)
    {
        fetch(`https://gpt-api-production-ba31.up.railway.app/${Model}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        mode: 'cors',
        body: JSON.stringify({
            prompt: MsgPrompt
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('–°–µ—Ç—å –æ—Ç–≤–µ—Ç–∏–ª–∞ —Å –æ—à–∏–±–∫–æ–π');
        }
        return response.json();
    })
    .then(data => {
        console.log("–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è –∏ –≤–µ—Ä–Ω—É–ª—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ");
        console.log(data);
        CreateNewMessageByGPT(data);  // —É—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç–≤–µ—Ç–∞
        return data
    })
    .catch(error => {
        console.error('–í–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º:', error);
        CreateNewMessageByGPT('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    });
    }
    
}

userInput.addEventListener('keydown', function(event) {
if (event.key === 'Enter') {
    if (event.shiftKey) {
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
        event.preventDefault();
        const cursorPos = userInput.selectionStart;
        const value = userInput.value;
        userInput.value = value.substring(0, cursorPos) + "\n" + value.substring(cursorPos);
        userInput.selectionStart = userInput.selectionEnd = cursorPos + 1;
        AutoResizeTextarea(); // –æ–±–Ω–æ–≤–∏–º –≤—ã—Å–æ—Ç—É
    } else {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        event.preventDefault();
        userInput.disabled = true;
        const MsgPrompt = userInput.value.trim();
        if (MsgPrompt !== '') {
            CreateNewMessageByUser(MsgPrompt);
            SendPromptNeiro(MsgPrompt, ActiveModel);  
            console.log("–ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å: " + ActiveModel);                          // –ó–î–ï–°–¨ –ú–ï–ù–Ø–ï–¢–°–Ø –ú–û–î–ï–õ–¨!!!!!
            userInput.value = '';
            AutoResizeTextarea();
        }
    }
}
});
function AutoResizeTextarea() {
userInput.style.height = "auto"; // —Å–±—Ä–æ—Å
const lineHeight = 20; // px, –º–æ–∂–µ—à—å —Ç–æ—á–Ω–æ –∑–∞–º–µ—Ä–∏—Ç—å –ø–æ —à—Ä–∏—Ñ—Ç—É
const maxHeight = lineHeight * 10;

if (userInput.scrollHeight > maxHeight) {
    userInput.style.height = maxHeight + "px";
    userInput.style.overflowY = "scroll";
} else {
    userInput.style.height = userInput.scrollHeight + "px";
    userInput.style.overflowY = "hidden";
}
}
userInput.addEventListener('input', AutoResizeTextarea);
let chatHistory = [];


function loadChatHistory() {
const stored = localStorage.getItem('chatHistory');
if (stored) {
    chatHistory = JSON.parse(stored);
    chatHistory.forEach(msg => {
        if (msg.role === "user") {
            CreateNewMessageByUser(msg.content, false);
        } else if (msg.role === "gpt") {
            CreateNewMessageByGPT(msg.content, false);
        }
    });
    AutoResizeTextarea();
}
}
loadChatHistory();

});




function removeHistory(){
    localStorage.clear();
    location.reload();
}
const BlockRemoveChat = document.getElementById("BlockRemoveChat").addEventListener("click", removeHistory);


const BtnModels = document.getElementsByClassName("BtnModels");


userInput.addEventListener("mouseover",() =>{
    if(ActiveModel == "")
    {
       userInput.placeholder = "–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å";
       userInput.classList.add("inputChatErrorModel");
    }
})

userInput.addEventListener("mouseout", () =>{

    userInput.classList.remove("inputChatErrorModel");
    userInput.placeholder = "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";
    
    
})

for (let i = 0; i < BtnModels.length; i++) {
    const model = BtnModels[i];

    model.addEventListener("click", () => {
        const BlockSelectModel = document.getElementById("BlockSelectModel");
        userInput.disabled = false;
        switch (model.textContent) {
            case "Chat GPT-4o":
                ActiveModel = "ChatGPT";
                break;
            case "Chat GPT-4o mini": 
                ActiveModel = "ChatGPTmini";
                break;
            case "DeepSeek":
                ActiveModel = "DeepSeek";
                break;
            case "Llama3-3":
                ActiveModel = "Llama3-3";
                break;
            default:
                ActiveModel = "–í—ã–±—Ä–∞—Ç—å –º–æ–¥–µ–ª—å";
                break;
        }
        BlockSelectModel.style.display = 'none';
        console.log("ActiveModel:", ActiveModel);
        document.getElementById("NameModelOnBtn").textContent = model.textContent;
    });
}
const BtnChangeModel = document.getElementById("BtnChangeModel");

BtnChangeModel.addEventListener("click", () =>{
    const BlockSelectModel = document.getElementById("BlockSelectModel");

    if(BlockSelectModel.style.display == 'none')
    {
        BlockSelectModel.style.display = 'block';        
    }else{
        BlockSelectModel.style.display = 'none';        
    }
})




</script>
{% endblock %}
